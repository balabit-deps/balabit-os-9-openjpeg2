From 1daaa0b909aebdf71be36238d16dfbec83c494ed Mon Sep 17 00:00:00 2001
From: Eharve14 <71228603+Eharve14@users.noreply.github.com>
Date: Thu, 13 Jan 2022 15:05:52 -0500
Subject: [PATCH] Avoid overflow in multiplications in utilities related to big
 number of files in a directory (CVE-2021-29338)  (#1396)

---
 src/bin/jp2/opj_compress.c   | 2 +-
 src/bin/jp2/opj_decompress.c | 4 ++--
 src/bin/jp2/opj_dump.c       | 4 ++--
 3 files changed, 5 insertions(+), 5 deletions(-)

Index: openjpeg2-2.4.0/src/bin/jp2/opj_compress.c
===================================================================
--- openjpeg2-2.4.0.orig/src/bin/jp2/opj_compress.c
+++ openjpeg2-2.4.0/src/bin/jp2/opj_compress.c
@@ -1918,7 +1918,7 @@ int main(int argc, char **argv)
                 goto fin;
             }
             for (i = 0; i < num_images; i++) {
-                dirptr->filename[i] = dirptr->filename_buf + i * OPJ_PATH_LEN;
+                dirptr->filename[i] = dirptr->filename_buf + (size_t)i * OPJ_PATH_LEN;
             }
         }
         if (load_images(dirptr, img_fol.imgdirpath) == 1) {
Index: openjpeg2-2.4.0/src/bin/jp2/opj_decompress.c
===================================================================
--- openjpeg2-2.4.0.orig/src/bin/jp2/opj_decompress.c
+++ openjpeg2-2.4.0/src/bin/jp2/opj_decompress.c
@@ -1350,7 +1350,6 @@ int main(int argc, char **argv)
     if (img_fol.set_imgdir == 1) {
         int it_image;
         num_images = get_num_images(img_fol.imgdirpath);
-
         dirptr = (dircnt_t*)malloc(sizeof(dircnt_t));
         if (!dirptr) {
             destroy_parameters(&parameters);
@@ -1370,7 +1369,8 @@ int main(int argc, char **argv)
             goto fin;
         }
         for (it_image = 0; it_image < num_images; it_image++) {
-            dirptr->filename[it_image] = dirptr->filename_buf + it_image * OPJ_PATH_LEN;
+            dirptr->filename[it_image] = dirptr->filename_buf + (size_t)it_image *
+                                         OPJ_PATH_LEN;
         }
 
         if (load_images(dirptr, img_fol.imgdirpath) == 1) {
Index: openjpeg2-2.4.0/src/bin/jp2/opj_dump.c
===================================================================
--- openjpeg2-2.4.0.orig/src/bin/jp2/opj_dump.c
+++ openjpeg2-2.4.0/src/bin/jp2/opj_dump.c
@@ -500,13 +500,13 @@ int main(int argc, char *argv[])
         }
 
         for (it_image = 0; it_image < num_images; it_image++) {
-            dirptr->filename[it_image] = dirptr->filename_buf + it_image * OPJ_PATH_LEN;
+            dirptr->filename[it_image] = dirptr->filename_buf + (size_t)it_image *
+                                         OPJ_PATH_LEN;
         }
 
         if (load_images(dirptr, img_fol.imgdirpath) == 1) {
             goto fails;
         }
-
         if (num_images == 0) {
             fprintf(stdout, "Folder is empty\n");
             goto fails;
